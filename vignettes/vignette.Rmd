---
title: "Introducing 'brat'"
subtitle: "A wrapper for the rapid annotation tool"
author: "Andreas BlÃ¤tte (andreas.blaette@uni-due.de)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introducing 'brat'}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---


## Requirements

Apart from the brat package, we load NLP which offers very useful data structure to get the data required by brat.

```{r}
library(brat) 
library(NLP)
```


## Minimal working example

A first minimal example uses the data included in the tutorial ['embedding brat visualisations]('https://brat.nlplab.org/embed.html).

First, we define document data that include the text and spans of text to be annotated.

```{r}
doc_data <- list(
   text = "Ed O'Kelley was the man who shot the man who shot Jesse James.",
   entities = list(
     list('T1', 'Person', list(c(0, 11))),
     list('T2', 'Person', list(c(20, 23))),
     list('T3', 'Person', list(c(37, 40))),
     list('T4', 'Person', list(c(50, 61)))
   )
)
```

Second, we define collection data, i.e. definitions that go beyond the individual documents applicable for an entire collection of documents.

```{r}
coll_data <- list(
  entity_types = list(list(
    type = "Person",
    labels = c("Person", "Per"),
    bgColor = "#7fa2ff",
    borderColor = "darken"
  ))
)
```

This is all it takes for a first brat visualisation.

```{r, eval = TRUE}
brat(doc_data = doc_data, coll_data = coll_data, width = "700px")
```


## Display POS tags

The package includes as sample data the object `millenium_declaration_annotated`, which is a `r is(millenium_declaration_annotated)` document. 

```{r}
millenium_declaration_annotated
```

It combines the plain text, offset annotations and metadata. We will need the text and extract it from the object.

```{r}
md_text <- as.character(millenium_declaration_annotated$content)
```

Second, we turn the POS annotations into the data format needed by brat.

```{r}
md_annotations <- NLP::annotation(millenium_declaration_annotated)

w <- subset(md_annotations, type == "word")

pos_data <- lapply(
  1:length(w),
  function(i)
    list(
      sprintf("T%d", i),
      features(w[[i]])[[1]],
      list(c(w[[i]]$start - 1L, w[[i]]$end ))
    )
)
doc_data <- list(text = md_text, entities = pos_data)
```

As collection data, we define a color scheme for all pos tags present.

```{r}
pos_tags <- unique(features(w)[,1])
pos_cols <- c(
  RColorBrewer::brewer.pal(12, "Set3"),
  RColorBrewer::brewer.pal(8, "Set2"),
  RColorBrewer::brewer.pal(9, "Set1"),
  RColorBrewer::brewer.pal(8, "Paired"),
  RColorBrewer::brewer.pal(8, "Accent")
)[1:length(pos_tags)]

coll_data <- list(
  entity_types = lapply(
  1L:length(pos_tags),
  function(i) list(
    type = pos_tags[[i]],
    labels = c(pos_tags[[i]], substr(pos_tags[[i]], 1, 1)),
    bgColor = pos_cols[[i]], borderColor = "darken"
  )
))
```

```{r, eval = TRUE}
brat(doc_data = doc_data, coll_data = coll_data, width = "700px")
```
